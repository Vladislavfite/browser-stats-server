<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f2f2f2; }
        h1 { color: #333; }
        table { border-collapse: collapse; width: 100%; background: white; margin-bottom: 10px; }
        td, th { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background-color: #eee; }
        #counts { margin-bottom: 20px; font-weight: bold; }
        button { margin-top: 20px; padding: 10px 20px; font-size: 16px; }
        canvas { background: #fff; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π</h1>
    <table>
        <thead>
            <tr>
                <th>–ò–º—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</th>
                <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∫–ª–∞–º—ã</th>
                <th>–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏</th>
                <th>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
            </tr>
        </thead>
        <tbody id="devices-body"></tbody>
    </table>
    <div id="counts"></div>
    <canvas id="adsChart" height="150"></canvas>
    <button onclick="resetStats()">üßπ –°–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>

    <script>
        const ctx = document.getElementById('adsChart').getContext('2d');
        const adsChart = new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [{ label: '–†–µ–∫–ª–∞–º–∞', data: [], borderColor: 'blue', fill: false }] },
            options: { scales: { y: { beginAtZero: true } } }
        });

        async function fetchDashboard() {
            const res = await fetch('/dashboard_data');
            const data = await res.json();

            const tbody = document.getElementById('devices-body');
            tbody.innerHTML = '';
            data.devices.forEach(dev => {
                const tr = document.createElement('tr');
                const date = new Date(dev.last_seen * 1000).toLocaleTimeString();
                const status = dev.status === 'online' ? 'üü¢ online' : 'üî¥ offline';
                tr.innerHTML = `<td>${dev.name}</td><td>${dev.ads}</td><td>${dev.reloads}</td><td>${date}</td><td>${status}</td>`;
                tbody.appendChild(tr);
            });
            const income = data.income.toFixed(2);
            document.getElementById('counts').textContent = `–ê–∫—Ç–∏–≤–Ω—ã—Ö: ${data.active} / –ù–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö: ${data.inactive} | –ü—Ä–æ—Å–º–æ—Ç—Ä–æ–≤: ${data.total_ads} | –î–æ—Ö–æ–¥: ${income}‚ÇΩ`;

            const labels = data.history.map(p => new Date(p.time * 1000).toLocaleTimeString());
            const values = data.history.map(p => p.ads);
            adsChart.data.labels = labels;
            adsChart.data.datasets[0].data = values;
            adsChart.update();
        }

        async function resetStats() {
            await fetch('/reset', { method: 'POST' });
            setTimeout(fetchDashboard, 1000);
        }

        fetchDashboard();
        setInterval(fetchDashboard, 60000);
    </script>
</body>
</html>
