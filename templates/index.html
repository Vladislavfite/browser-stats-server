<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f2f2f2; }
        h1 { color: #333; }
        table { border-collapse: collapse; width: 100%; background: white; margin-bottom: 10px; }
        td, th { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background-color: #eee; }
        #counts { margin-bottom: 20px; font-weight: bold; }
        button { margin-top: 20px; padding: 10px 20px; font-size: 16px; }
    </style>
</head>
<body>
    <h1>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π</h1>
    <table>
        <thead>
            <tr>
                <th id="nameHeader" style="cursor:pointer">–ò–º—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</th>
                <th id="adsHeader" style="cursor:pointer">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∫–ª–∞–º—ã</th>
                <th>–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏</th>
                <th>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
            </tr>
        </thead>
        <tbody id="devices-body"></tbody>
    </table>
    <div id="counts"></div>
    <button onclick="resetStats()">üßπ –°–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>

    <script>
        let sortBy = 'name';
        let sortAsc = true;

        document.getElementById('nameHeader').addEventListener('click', () => toggleSort('name'));
        document.getElementById('adsHeader').addEventListener('click', () => toggleSort('ads'));

        function toggleSort(field) {
            if (sortBy === field) {
                sortAsc = !sortAsc;
            } else {
                sortBy = field;
                sortAsc = true;
            }
            fetchDashboard();
        }

        function sortDevices(devices) {
            return devices.sort((a, b) => {
                let x = a[sortBy];
                let y = b[sortBy];
                if (typeof x === 'string') x = x.toLowerCase();
                if (typeof y === 'string') y = y.toLowerCase();
                if (x < y) return sortAsc ? -1 : 1;
                if (x > y) return sortAsc ? 1 : -1;
                return 0;
            });
        }

        async function fetchDashboard() {
            const res = await fetch('/dashboard_data');
            const data = await res.json();

            const tbody = document.getElementById('devices-body');
            tbody.innerHTML = '';
            const devices = sortDevices(data.devices.slice());
            devices.forEach(dev => {
                const tr = document.createElement('tr');
                const date = new Date(dev.last_seen * 1000).toLocaleTimeString();
                const status = dev.status === 'online' ? 'üü¢ online' : 'üî¥ offline';
                tr.innerHTML = `<td>${dev.name}</td><td>${dev.ads}</td><td>${dev.reloads}</td><td>${date}</td><td>${status}</td>`;
                tbody.appendChild(tr);
            });
            const income = data.income.toFixed(2);
            document.getElementById('counts').textContent = `–ê–∫—Ç–∏–≤–Ω—ã—Ö: ${data.active} / –ù–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö: ${data.inactive} | –ü—Ä–æ—Å–º–æ—Ç—Ä–æ–≤: ${data.total_ads} | –î–æ—Ö–æ–¥: ${income}‚ÇΩ`;

        }

        async function resetStats() {
            await fetch('/reset', { method: 'POST' });
            setTimeout(fetchDashboard, 1000);
        }

        fetchDashboard();
        setInterval(fetchDashboard, 10000);
    </script>
</body>
</html>
